<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MentorBot</title>

<style>
:root{
    --panel:#0f1a18;
    --bubble-user:#075e54;
    --bubble-user-light:#128c7e;
    --bubble-bot:#1d2a29;
    --accent:#25D366;
    --input-bg:#07100f;
}

html,body{
    height:100%;
    margin:0;
    font-family: "Segoe UI", Arial, sans-serif;
    background:#07120f;
    color: #e6efea;
}

.app {
    width:100%;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:10px;
}

.panel {
    width:420px;
    max-width:100%;
    height:90vh;
    background:var(--panel);
    border-radius:16px;
    display:flex;
    flex-direction:column;
    overflow:hidden;
}

.header {
    height:60px;
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px 14px;
    border-bottom:1px solid #222;
}

.logo {
    width:40px;
    height:40px;
    border-radius:10px;
    background:var(--accent);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    color:#04251f;
}

#chatBox {
    flex:1;
    padding:14px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:10px;
}

.row { display:flex; }
.row.user { justify-content:flex-end; }
.row.bot { justify-content:flex-start; }

.msg {
    max-width:78%;
    padding:10px 12px;
    border-radius:14px;
    font-size:14px;
    line-height:1.5;
}

.msg.user {
    background:var(--bubble-user);
}

.msg.bot {
    background:var(--bubble-bot);
}

/* Bot formatting */
.msg.bot strong {
    display:block;
    margin-top:6px;
    margin-bottom:6px;
    color:#9fffd7;
}

.msg.bot ul {
    padding-left:18px;
    margin:6px 0;
}

.msg.bot li {
    margin-bottom:4px;
}

.composer {
    display:flex;
    gap:8px;
    padding:12px;
    border-top:1px solid #222;
}

.input {
    flex:1;
    display:flex;
    background:var(--input-bg);
    border-radius:12px;
    padding:8px;
}

.input input {
    flex:1;
    background:transparent;
    border:none;
    outline:none;
    color:white;
    font-size:15px;
}

.send {
    background:var(--accent);
    border:none;
    padding:10px 16px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
}

.typing {
    display:flex;
    gap:6px;
    padding:10px 14px;
}

.dot {
    width:8px;
    height:8px;
    border-radius:50%;
    background:#aaa;
    animation: blink 1s infinite;
}

@keyframes blink {
    0% {opacity:.3;}
    50% {opacity:1;}
    100% {opacity:.3;}
}
</style>
</head>

<body>
<div class="app">
    <div class="panel">

        <div class="header">
            <div class="logo">MB</div>
            <h3>MentorBot</h3>
        </div>

        <div id="chatBox"></div>

        <div id="typingIndicator" class="typing" style="display:none;">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>

        <div class="composer">
            <div class="input">
                <input id="messageInput" placeholder="Type your question..." />
            </div>
            <button id="sendBtn" class="send">Send</button>
        </div>

    </div>
</div>

<script>
const chatBox = document.getElementById('chatBox');
const typingIndicator = document.getElementById('typingIndicator');
const sendBtn = document.getElementById('sendBtn');
const messageInput = document.getElementById('messageInput');

/* Convert plain text to formatted UI */
function formatBotText(text) {
    // Convert TITLE: to bold heading
    text = text.replace(/TITLE:\s*(.+)/g, "<strong>$1</strong>");

    // Convert POINTS to bullets
    if (text.includes("POINTS:")) {
        const parts = text.split("POINTS:");
        const before = parts[0];
        const pointsText = parts[1];

        const items = pointsText.split("-").filter(x => x.trim() !== "");
        let ul = "<ul>";
        items.forEach(item => {
            ul += "<li>" + item.trim() + "</li>";
        });
        ul += "</ul>";

        return before + ul;
    }

    return text;
}

function addUserMessage(text){
    const row = document.createElement('div');
    row.className = 'row user';

    const bubble = document.createElement('div');
    bubble.className = 'msg user';
    bubble.textContent = text;

    row.appendChild(bubble);
    chatBox.appendChild(row);
    chatBox.scrollTop = chatBox.scrollHeight;
}

async function sendStreamMessage(message){
    try {
        addUserMessage(message);
        typingIndicator.style.display = 'flex';

        const resp = await fetch('https://mentorbot-production-b34b.up.railway.app/chat-stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();

        const row = document.createElement('div');
        row.className = 'row bot';

        const bubble = document.createElement('div');
        bubble.className = 'msg bot';
        row.appendChild(bubble);

        chatBox.appendChild(row);

        let fullText = "";

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            fullText += chunk;

            bubble.innerHTML = formatBotText(fullText);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        typingIndicator.style.display = 'none';

    } catch (err) {
        typingIndicator.style.display = 'none';

        const row = document.createElement('div');
        row.className = 'row bot';

        const bubble = document.createElement('div');
        bubble.className = 'msg bot';
        bubble.textContent = "Server error. Please try again.";

        row.appendChild(bubble);
        chatBox.appendChild(row);
    }
}

sendBtn.onclick = () => {
    const text = messageInput.value.trim();
    if (!text) return;
    messageInput.value = "";
    sendStreamMessage(text);
};

messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendBtn.click();
});
</script>
</body>
</html>
